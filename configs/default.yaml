# Urban Structure Analysis System - 統合設定ファイル
# ============================================================

# ===== Phase 1: Acquisition & Space =====
canvas:
  half_size_m: 1000        # 中心から±1000m = 2km四方
  resolution_m: 1.0        # 1px = 1m

road_width_fallback:
  motorway: 20
  trunk: 15
  primary: 12
  secondary: 10
  tertiary: 8
  residential: 6
  service: 4
  default: 5

# ===== Phase 3: Analysis Engine =====
analysis:
  # 共通スケールレンジ（全指標で統一）
  r_min: 2
  r_max: 512
  r_steps: 20              # log2スケールで生成

  mfa:
    q_min: -10
    q_max: 10
    q_steps: 41
    grid_shift_count: 16   # グリッドシフト平均化

  lacunarity:
    method: "integral_image"  # or "gliding_box"
    full_scan: true           # 全画素探索

  percolation:
    d_min: 1
    d_max: 100
    d_steps: 50
    distance_type: "shortest_path"  # "edge" (fast) or "shortest_path" (accurate)
    node_filter: null               # null for all nodes, "building" for buildings only

  path_diversity:
    enabled: false                  # Separate from percolation analysis
    max_paths: 5
    length_tolerance: 1.5
    sample_pairs: 1000              # null for all pairs (expensive)

  # クラスタリング設定
  clustering:
    # 特徴抽出パラメータ
    feature_extraction:
      mfa_q_values: [0, 1, 2]           # 抽出する一般化次元 D(q)
      lacunarity_scales: [4, 16, 64]    # ラクナリティを抽出するスケール
      percolation_fractions: [0.1, 0.5, 0.9]  # 臨界閾値の計算に使う分率
    
    # 正規化方法: standard (Z-score), minmax, robust
    normalization: "standard"
    
    # クラスタリング方法: kmeans, dbscan, hierarchical
    method: "kmeans"
    n_clusters: 5
    
    # DBSCANパラメータ
    dbscan_eps: 0.5
    dbscan_min_samples: 3
    
    # 階層的クラスタリングパラメータ
    hierarchical_linkage: "ward"  # ward, complete, average, single
    
    # 次元削減: pca, none
    dimension_reduction: "none"
    pca_n_components: 3           # int: 成分数, float: 説明分散率

# ===== Phase 4: Visualization =====
visualization:
  # 空間的可視化設定
  spatial:
    enabled: true              # 空間的可視化を有効化
    show_buildings: true       # 建物を表示
    show_roads: true          # 道路を表示
    show_network: true        # ネットワークを表示
    heatmap_opacity: 0.7      # ヒートマップの不透明度
    marker_size_range: [5, 20]  # マーカーサイズの範囲
  
  # 指標と画像対応ビュー設定
  indicator_image_view:
    enabled: true              # 指標と画像対応ビューを有効化
    chart_height: 400         # チャートの高さ（px）
    chart_min_width: 1200     # チャートの最小幅（px）
    image_size_per_point: 200 # 地点あたりの画像サイズ（px）
    gallery_columns: "auto"   # ギャラリーの列数（"auto" or 数値）
    thumbnail_size: 200       # サムネイル画像サイズ（px）
    highlight_color: "rgba(255, 0, 0, 1.0)"  # ハイライト色
  
  # クラスターと画像対応ビュー設定
  cluster_image_view:
    enabled: true              # クラスターと画像対応ビューを有効化
    plot_height: 800          # プロットの高さ（px）
    point_size: 8             # ポイントサイズ（px）
    representative_image_size: 50  # 代表画像サイズ（座標単位）
    point_image_size: 20      # ポイント画像サイズ（座標単位）
    zoom_threshold: 0.5       # 画像表示に切り替えるズーム閾値
    max_images_per_zoom: 50   # ズームレベルあたりの最大画像数
    cluster_colors:           # クラスター色のリスト
      - "#1f77b4"
      - "#ff7f0e"
      - "#2ca02c"
      - "#d62728"
      - "#9467bd"

# ===== Execution =====
execution:
  n_jobs: -1               # joblib並列数 (-1 = 全コア)
  cache_integral: true     # 積分画像をキャッシュ
  verbose: true

# ===== Clustering =====
clustering:
  # 前処理設定
  preprocessing:
    normalization_method: "minmax"  # "minmax", "standard", "robust" (比較結果で最適: minmax)
    dimensionality_reduction: "pca"  # "pca", "umap", "tsne", null
    n_components: null              # null = 自動選択 (PCA: 95%分散, その他: 2)
    random_state: 42
  
  # クラスタリング設定
  method: "kmeans"         # "kmeans", "dbscan", "hierarchical"
  n_clusters: null         # null = エルボー法で自動最適化
  eps: 0.5                 # DBSCAN用 (最適化時は無視)
  min_samples: 3          # DBSCAN用 (最適化時は無視)
  linkage: "ward"         # Hierarchical用 ("ward", "complete", "average")
  
  # 最適化設定
  optimization:
    # エルボー法によるクラスタ数最適化
    use_elbow_method: true           # true = エルボー法を使用, false = n_clustersを直接指定
    min_clusters: 2                  # 最小クラスタ数
    max_clusters: 10                 # 最大クラスタ数
    elbow_metric: "silhouette"       # "inertia", "silhouette", "davies_bouldin"
    
    # DBSCANパラメータ探索範囲
    dbscan_eps_range: [0.1, 0.3, 0.5, 0.7, 1.0]  # eps探索範囲
    dbscan_min_samples_range: [2, 3, 4, 5]      # min_samples探索範囲
    
    # 複数クラスタ数での比較
    compare_cluster_numbers: true    # true = 複数のクラスタ数で比較
    cluster_numbers_to_compare: null  # null = min_clustersからmax_clustersまで全て
    
    # 結果の解釈
    interpret_results: true          # true = クラスタごとの特徴量統計を計算

