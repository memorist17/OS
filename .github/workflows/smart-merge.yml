name: Smart Merge Strategy

on:
  pull_request:
    types: [opened, synchronize, ready_for_review]

jobs:
  evaluate-merge:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
      
      - name: Install dependencies
        run: |
          uv venv
          source .venv/bin/activate
          uv pip install -e ".[dev]"
      
      - name: Determine Target Branch
        id: target
        run: |
          TARGET="${{ github.event.pull_request.base.ref }}"
          echo "target_branch=$TARGET" >> $GITHUB_OUTPUT
          
          if [ "$TARGET" == "main" ]; then
            echo "min_score=90" >> $GITHUB_OUTPUT
            echo "min_coverage=80" >> $GITHUB_OUTPUT
            echo "require_reproducibility=true" >> $GITHUB_OUTPUT
          elif [ "$TARGET" == "stage" ]; then
            echo "min_score=75" >> $GITHUB_OUTPUT
            echo "min_coverage=60" >> $GITHUB_OUTPUT
            echo "require_reproducibility=true" >> $GITHUB_OUTPUT
          else
            echo "min_score=60" >> $GITHUB_OUTPUT
            echo "min_coverage=40" >> $GITHUB_OUTPUT
            echo "require_reproducibility=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Run Tests
        run: |
          source .venv/bin/activate
          pytest tests/ -v --cov=src --cov-report=json || true
      
      - name: Code Quality Check
        run: |
          source .venv/bin/activate
          ruff check src/ --output-format=json > ruff-report.json || true
      
      - name: Evaluate PR
        id: evaluation
        run: |
          source .venv/bin/activate
          python scripts/evaluate_pr_quality.py \
            --target-branch ${{ steps.target.outputs.target_branch }} \
            --min-score ${{ steps.target.outputs.min_score }} \
            --min-coverage ${{ steps.target.outputs.min_coverage }} \
            --branch ${{ github.head_ref }} \
            --coverage-report coverage.json \
            --ruff-report ruff-report.json \
            --pr-number ${{ github.event.pull_request.number }} || true
        continue-on-error: true
      
      - name: Check Experiment Results
        if: steps.target.outputs.require_reproducibility == 'true'
        run: |
          source .venv/bin/activate
          python scripts/check_reproducibility.py \
            --check-snapshots \
            --outputs-dir outputs/ || echo "Warning: Some experiments may not have config snapshots"
      
      - name: Auto-Merge Decision
        uses: actions/github-script@v6
        if: always()
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const target = '${{ steps.target.outputs.target_branch }}';
            const minScore = parseFloat('${{ steps.target.outputs.min_score }}');
            const minCoverage = parseFloat('${{ steps.target.outputs.min_coverage }}');
            
            // evaluation outputsからスコアを取得（デフォルト値）
            const score = parseFloat('${{ steps.evaluation.outputs.total_score }}') || 0;
            const coverage = parseFloat('${{ steps.evaluation.outputs.test_coverage }}') || 0;
            
            let canAutoMerge = false;
            let reason = '';
            
            if (target === 'dev' && score >= 60 && coverage >= 40) {
              canAutoMerge = true;
              reason = 'devブランチ: 低品質基準を満たしています';
            } else if (target === 'stage' && score >= 75 && coverage >= 60) {
              canAutoMerge = true;
              reason = 'stageブランチ: 実験結果が有意です';
            } else if (target === 'main' && score >= 90 && coverage >= 80) {
              // mainは自動マージしない（レビュー必須）
              canAutoMerge = false;
              reason = 'mainブランチ: レビューが必要です（自動マージ不可）';
            } else {
              reason = `スコア ${score.toFixed(1)} または カバレッジ ${coverage.toFixed(1)}% が最小基準を下回っています`;
            }
            
            const comment = `## マージ評価結果
            
            **ターゲットブランチ**: \`${target}\`
            **総合スコア**: ${score.toFixed(1)}/${minScore}
            **テストカバレッジ**: ${coverage.toFixed(1)}%/${minCoverage}%
            
            ${canAutoMerge ? `✅ **自動マージ可能**: ${reason}` : `❌ **レビュー必要**: ${reason}`}
            
            ${target === 'main' ? '⚠️ mainブランチへのマージは必ずレビューが必要です' : ''}
            
            ### 詳細メトリクス
            - コード品質: ${{ steps.evaluation.outputs.code_quality || 'N/A' }}
            - コンフリクトリスク: ${{ steps.evaluation.outputs.conflict_risk || 'N/A' }}
            - 実験結果: ${{ steps.evaluation.outputs.has_experiments || 'false' }}
            `;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });

